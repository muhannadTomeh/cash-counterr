<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø¯Ù‘ ÙØ¦Ø§Øª Ø§Ù„Ù†Ù‚ÙˆØ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’°</text></svg>">
    
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø²ÙŠØ§Ø¯Ø©/Ù†Ù‚ØµØ§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            input { border: none !important; box-shadow: none !important; background: transparent !important; }
            .card-shadow { box-shadow: none !important; border: 1px solid #ddd !important; }
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 text-right text-slate-900">

    <div class="mx-auto max-w-5xl">
        <div class="rounded-2xl border border-slate-200 bg-white shadow-md card-shadow overflow-hidden">
            
            <div class="space-y-4 border-b border-slate-200 bg-gradient-to-l from-indigo-50 to-white p-6">
                <div class="text-center space-y-1">
                    <h1 class="text-2xl font-bold tracking-tight">ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø¯Ù‘ ÙØ¦Ø§Øª Ø§Ù„Ù†Ù‚ÙˆØ¯</h1>
                    <div class="text-sm text-slate-500">
                        Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ÙƒÙ„ ÙØ¦Ø©ØŒ ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ ÙˆØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø²ÙŠØ§Ø¯Ø©/Ø§Ù„Ù†Ù‚ØµØ§Ù†.
                    </div>
                </div>

                <div class="bg-slate-100 p-1 rounded-2xl flex flex-row-reverse w-full">
                    <button onclick="switchTab('credit')" id="tab-btn-credit" class="flex-1 rounded-xl py-2 text-sm font-medium transition-all text-slate-500 hover:text-slate-900">
                        Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†
                    </button>
                    <button onclick="switchTab('cash')" id="tab-btn-cash" class="flex-1 rounded-xl py-2 text-sm font-medium transition-all bg-indigo-600 text-white shadow-sm">
                        Ù†Ù‚Ø¯
                    </button>
                </div>

                <div id="content-cash" class="tab-content active mt-4">
                    
                    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div class="flex gap-2 justify-end order-1 md:order-2">
                            <button onclick="setCurrency('ILS')" id="curr-ILS" class="h-9 px-4 rounded-xl text-sm font-medium transition-colors bg-indigo-600 text-white hover:bg-indigo-700">ILS</button>
                            <button onclick="setCurrency('JOD')" id="curr-JOD" class="h-9 px-4 rounded-xl text-sm font-medium transition-colors border border-slate-200 hover:bg-slate-100 bg-transparent text-slate-900">JOD</button>
                            <button onclick="setCurrency('USD')" id="curr-USD" class="h-9 px-4 rounded-xl text-sm font-medium transition-colors border border-slate-200 hover:bg-slate-100 bg-transparent text-slate-900">USD</button>
                        </div>
                        <div class="text-left text-sm text-slate-500 order-2 md:order-1 ml-auto">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</div>
                    </div>

                    <div class="h-[1px] bg-slate-200 my-4"></div>

                    <div class="grid gap-3 md:grid-cols-2">
                        <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                            <div class="text-sm text-slate-500">Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</div>
                            <input type="text" id="openingCash" oninput="updateCalculations()" inputmode="decimal" placeholder="0.000" class="flex h-9 w-full rounded-md border border-slate-200 bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-indigo-600 mt-2 text-right">
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                            <div class="text-sm text-slate-500">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                            <input type="text" id="netSales" oninput="updateCalculations()" inputmode="decimal" placeholder="0.000" class="flex h-9 w-full rounded-md border border-slate-200 bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-indigo-600 mt-2 text-right">
                        </div>
                    </div>

                    <div class="h-[1px] bg-slate-200 my-4"></div>

                    <div class="rounded-2xl border border-slate-200 bg-white/80 overflow-hidden">
                        <table class="w-full caption-bottom text-sm">
                            <thead class="[&_tr]:border-b">
                                <tr class="border-b border-slate-200 bg-slate-50 transition-colors">
                                    <th class="h-10 px-4 text-right align-middle font-medium text-slate-500">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ¦Ø©</th>
                                    <th class="h-10 px-4 text-right align-middle font-medium text-slate-500">Ø§Ù„Ø¹Ø¯Ø¯</th>
                                    <th class="h-10 px-4 text-right align-middle font-medium text-slate-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody id="denominations-body" class="[&_tr:last-child]:border-0">
                                </tbody>
                        </table>
                    </div>

                    <div class="mt-4 grid gap-3 md:grid-cols-3">
                        <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                            <div class="text-sm text-slate-500">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
                            <div id="display-realTotal" class="mt-1 text-2xl font-semibold tabular-nums">0.000 ILS</div>
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                            <div class="text-sm text-slate-500">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…Ø¹Ø¯ÙˆØ¯</div>
                            <div id="display-countedCash" class="mt-1 text-2xl font-semibold tabular-nums">0.000 ILS</div>
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                            <div class="text-sm text-slate-500">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</div>
                            <div id="display-creditTotal-summary" class="mt-1 text-2xl font-semibold tabular-nums">0.000 ILS</div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                            <div class="text-sm text-slate-500">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                            <div id="display-expectedTotal" class="mt-1 text-2xl font-semibold tabular-nums">0.000 ILS</div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div id="variance-box" class="rounded-2xl border p-4 bg-emerald-50 border-emerald-200">
                            <div class="text-sm text-slate-500">Ø§Ù„Ø²ÙŠØ§Ø¯Ø© / Ø§Ù„Ù†Ù‚ØµØ§Ù† ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
                            <div id="display-variance" class="mt-1 text-lg font-semibold tabular-nums text-slate-900">Ù…Ø·Ø§Ø¨Ù‚ (0.000)</div>
                        </div>
                    </div>

                    <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:justify-end no-print">
                        <button onclick="resetAll()" class="inline-flex items-center justify-center rounded-xl text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-slate-200 bg-white hover:bg-slate-100 hover:text-slate-900 h-10 px-4 py-2 gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"/><path d="M3 3v9h9"/></svg>
                            ØªØµÙÙŠØ±
                        </button>
                        <button onclick="onSave()" class="inline-flex items-center justify-center rounded-xl text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-900 text-slate-50 hover:bg-slate-900/90 h-10 px-4 py-2 gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8V3"/></svg>
                            Ø­ÙØ¸
                        </button>
                        <button onclick="onSaveAndPrint()" class="inline-flex items-center justify-center rounded-xl text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-indigo-600 text-white hover:bg-indigo-700 h-10 px-4 py-2 gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>

                <div id="content-credit" class="tab-content mt-4">
                    <div class="rounded-2xl border border-slate-200 bg-white/80 p-4">
                        <div class="flex flex-row-reverse items-center justify-between gap-3">
                            <div>
                                <div class="text-sm text-slate-500">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</div>
                                <div class="mt-1 text-xs text-slate-500">
                                    Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ø¶ØºØ· (Ø¥Ø¶Ø§ÙØ©) Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨Ù‡ Ø¶Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†.
                                </div>
                            </div>
                            <div class="text-sm tabular-nums text-slate-500">
                                Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 
                                <span id="credit-tab-total" class="font-semibold text-slate-900">0.000 ILS</span>
                            </div>
                        </div>

                        <div class="h-[1px] bg-slate-200 my-4"></div>

                        <div class="flex flex-col gap-3 md">
                            <div class="w-full md:w-1/3">
                                <div class="mb-1 text-sm text-right font-medium">Ø§Ù„Ù…Ø¨Ù„Øº</div>
                                <input id="creditInputAmount" type="text" inputmode="decimal" placeholder="0.000" class="flex h-9 w-full rounded-md border border-slate-200 bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-indigo-600 text-right">
                            </div>
                            <div class="w-full md:w-2/3">
                                <div class="mb-1 text-sm text-right font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
                                <input id="creditInputNote" type="text" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" class="flex h-9 w-full rounded-md border border-slate-200 bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-indigo-600 text-right">
                            </div>
                        </div>

                        <div class="mt-3 flex justify-end">
                            <button id="btnAddCredit" onclick="addCreditEntry()" class="inline-flex items-center justify-center rounded-xl text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-indigo-600 text-white hover:bg-indigo-700 h-9 px-4 py-2 gap-2 opacity-50 cursor-not-allowed" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>

                        <div class="h-[1px] bg-slate-200 my-4"></div>

                        <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
                            <table class="w-full caption-bottom text-sm">
                                <thead class="[&_tr]:border-b">
                                    <tr class="border-b border-slate-200 bg-slate-50 transition-colors">
                                        <th class="h-10 px-4 text-right align-middle font-medium text-slate-500">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th class="h-10 px-4 text-right align-middle font-medium text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                        <th class="h-10 px-4 text-right align-middle font-medium text-slate-500">Ø­Ø°Ù</th>
                                    </tr>
                                </thead>
                                <tbody id="credit-table-body" class="[&_tr:last-child]:border-0">
                                    <tr>
                                        <td class="p-4 text-right text-slate-500 align-middle" colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <div class="p-6 pt-0 mt-6">
                <div class="text-xs text-slate-500">
                    Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ = Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ + ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ = Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…Ø¹Ø¯ÙˆØ¯ + Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†ØŒ ÙˆØ§Ù„ÙØ±Ù‚ = Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ - Ø§Ù„Ù…ØªÙˆÙ‚Ø¹.
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª ---
        const currencyPresets = {
            ILS: [200, 100, 50, 20, 10, 5, 2, 1, 0.5],
            JOD: [50, 20, 10, 5, 1, 0.5, 0.25, 0.1, 0.05],
            USD: [100, 50, 20, 10, 5, 2, 1, 0.5, 0.25]
        };

        let state = {
            currency: "ILS",
            counts: {}, 
            openingCash: 0,
            netSales: 0,
            creditEntries: [], 
        };

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function round3(n) { return Math.round(n * 1000) / 1000; }
        function formatMoney(val, curr) { return `${round3(val).toFixed(3)} ${curr}`; }
        function safeAmount(str) { const n = parseFloat(str); return isNaN(n) ? 0 : n; }
        function safeInt(str) { const n = parseFloat(str); return isNaN(n) ? 0 : Math.floor(n); }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        // --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ---
        document.addEventListener('DOMContentLoaded', () => {
            renderDenominationTable();
            updateCalculations();
            setupCreditInputListener();
        });

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.add('active');

            const btnCash = document.getElementById('tab-btn-cash');
            const btnCredit = document.getElementById('tab-btn-credit');

            if (tabName === 'cash') {
                btnCash.className = "flex-1 rounded-xl py-2 text-sm font-medium transition-all bg-indigo-600 text-white shadow-sm";
                btnCredit.className = "flex-1 rounded-xl py-2 text-sm font-medium transition-all text-slate-500 hover:text-slate-900";
            } else {
                btnCredit.className = "flex-1 rounded-xl py-2 text-sm font-medium transition-all bg-indigo-600 text-white shadow-sm";
                btnCash.className = "flex-1 rounded-xl py-2 text-sm font-medium transition-all text-slate-500 hover:text-slate-900";
            }
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø© ---
        function setCurrency(curr) {
            state.currency = curr;
            state.counts = {}; 
            
            ['ILS', 'JOD', 'USD'].forEach(c => {
                const btn = document.getElementById(`curr-${c}`);
                if (c === curr) {
                    btn.className = "h-9 px-4 rounded-xl text-sm font-medium transition-colors bg-indigo-600 text-white hover:bg-indigo-700";
                } else {
                    btn.className = "h-9 px-4 rounded-xl text-sm font-medium transition-colors border border-slate-200 hover:bg-slate-100 bg-transparent text-slate-900";
                }
            });

            renderDenominationTable();
            updateCalculations();
        }

        // --- Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª ---
        function renderDenominationTable() {
            const tbody = document.getElementById('denominations-body');
            tbody.innerHTML = '';
            
            const denoms = currencyPresets[state.currency];
            
            denoms.forEach((d, idx) => {
                const count = state.counts[d] || 0;
                const total = d * count;
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-200 transition-colors hover:bg-slate-50/50 data-[state=selected]:bg-slate-100";
                
                // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
                tr.innerHTML = `
                    <td class="p-4 align-middle text-right font-medium text-slate-900">
                        ${d}
                    </td>
                    <td class="p-4 align-middle text-right">
                        <input type="number" min="0" placeholder="0" 
                            class="flex h-9 w-full rounded-md border border-slate-200 bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-indigo-600 text-right"
                            oninput="updateCount(${d}, this.value)"
                            value="${count === 0 ? '' : count}">
                    </td>
                    <td class="p-4 align-middle text-right tabular-nums text-slate-700" id="row-total-${d}">
                        ${formatMoney(total, state.currency)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
        function updateCount(denom, val) {
            state.counts[denom] = safeInt(val);
            const totalCell = document.getElementById(`row-total-${denom}`);
            if(totalCell) {
                totalCell.innerText = formatMoney(denom * state.counts[denom], state.currency);
            }
            updateCalculations();
        }

        function updateCalculations() {
            state.openingCash = safeAmount(document.getElementById('openingCash').value);
            state.netSales = safeAmount(document.getElementById('netSales').value);

            let countedCash = 0;
            const denoms = currencyPresets[state.currency];
            denoms.forEach(d => {
                countedCash += d * (state.counts[d] || 0);
            });

            const creditTotal = state.creditEntries.reduce((acc, curr) => acc + curr.amount, 0);
            const realTotal = countedCash + creditTotal;
            const expectedTotal = state.openingCash + state.netSales;
            const variance = round3(realTotal - expectedTotal);

            document.getElementById('display-countedCash').innerText = formatMoney(countedCash, state.currency);
            document.getElementById('display-creditTotal-summary').innerText = formatMoney(creditTotal, state.currency);
            document.getElementById('display-realTotal').innerText = formatMoney(realTotal, state.currency);
            document.getElementById('display-expectedTotal').innerText = formatMoney(expectedTotal, state.currency);
            document.getElementById('credit-tab-total').innerText = formatMoney(creditTotal, state.currency);

            const vBox = document.getElementById('variance-box');
            const vText = document.getElementById('display-variance');
            
            vBox.className = "rounded-2xl border p-4 transition-colors";

            if (Math.abs(variance) <= 0.0005) {
                vBox.classList.add('bg-emerald-50', 'border-emerald-200');
                vText.innerText = "Ù…Ø·Ø§Ø¨Ù‚ (0.000)";
            } else if (variance > 0) {
                vBox.classList.add('bg-amber-50', 'border-amber-200');
                vText.innerText = `Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatMoney(Math.abs(variance), state.currency)}`;
            } else {
                vBox.classList.add('bg-rose-50', 'border-rose-200');
                vText.innerText = `Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatMoney(Math.abs(variance), state.currency)}`;
            }
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù† ---
        function setupCreditInputListener() {
            const input = document.getElementById('creditInputAmount');
            const btn = document.getElementById('btnAddCredit');
            
            input.addEventListener('input', () => {
                const val = parseFloat(input.value);
                if (val > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        function addCreditEntry() {
            const amtInput = document.getElementById('creditInputAmount');
            const noteInput = document.getElementById('creditInputNote');
            const amt = safeAmount(amtInput.value);
            
            if (amt <= 0) return;

            const entry = {
                id: generateId(),
                amount: amt,
                note: noteInput.value.trim()
            };

            state.creditEntries.unshift(entry); 
            
            amtInput.value = '';
            noteInput.value = '';
            document.getElementById('btnAddCredit').disabled = true;
            document.getElementById('btnAddCredit').classList.add('opacity-50', 'cursor-not-allowed');

            renderCreditTable();
            updateCalculations();
        }

        function removeCreditEntry(id) {
            state.creditEntries = state.creditEntries.filter(e => e.id !== id);
            renderCreditTable();
            updateCalculations();
        }

        function renderCreditTable() {
            const tbody = document.getElementById('credit-table-body');
            tbody.innerHTML = '';

            if (state.creditEntries.length === 0) {
                tbody.innerHTML = `<tr><td class="p-4 text-right text-slate-500 align-middle" colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</td></tr>`;
                return;
            }

            state.creditEntries.forEach(e => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-200 transition-colors hover:bg-slate-50/50";
                tr.innerHTML = `
                    <td class="p-4 align-middle text-right tabular-nums font-medium">
                        ${formatMoney(e.amount, state.currency)}
                    </td>
                    <td class="p-4 align-middle text-right text-slate-600">
                        ${e.note || '-'}
                    </td>
                    <td class="p-4 align-middle text-right">
                        <button onclick="removeCreditEntry('${e.id}')" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none hover:bg-slate-100 h-8 w-8 text-slate-500 hover:text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© ---
        function resetAll() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                state.counts = {};
                state.openingCash = 0;
                state.netSales = 0;
                state.creditEntries = [];
                
                document.getElementById('openingCash').value = '';
                document.getElementById('netSales').value = '';
                document.getElementById('creditInputAmount').value = '';
                document.getElementById('creditInputNote').value = '';

                renderDenominationTable();
                renderCreditTable();
                updateCalculations();
            }
        }

        function onSave() {
            console.log("Saving Data:", state);
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ (Ù…Ø­Ø§ÙƒØ§Ø©). Ø±Ø§Ø¬Ø¹ Console Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ§Ø¦Ù†.');
        }

        function onSaveAndPrint() {
            onSave();
            setTimeout(() => {
                window.print();
            }, 500);
        }
    </script>
</body>

</html>
